<div class="partial-picking-screen">
  <div class="partial-picking-shell" [formGroup]="partialPickingForm">

    <!-- Large Progress Bar -->
    <app-weight-progress-bar
      [currentWeight]="currentWeight()"
      [config]="progressConfig()"
      [isConnected]="isScaleConnected()"
      [isStable]="isWeightStable()"
      (tareScale)="onTareScale()"
      (reconnectScale)="onReconnectScale()"
      (fetchWeight)="onFetchWeight()">
    </app-weight-progress-bar>

    <!-- Header Row 1: Run No, FG Item Key, and Scale Switcher -->
    <div class="header-row header-row-with-scale-switcher">
      <div class="header-field">
        <label class="field-label">Run No</label>
        <div class="input-wrap">
          <input type="text" formControlName="runNo" />
          <button type="button" class="lookup-btn" (click)="onLookup('runNo')" aria-label="Lookup run number">üîç</button>
        </div>
      </div>
      <div class="header-field fg-field">
        <label class="field-label">FG ItemKey</label>
        <div class="fg-cell">
          <div class="input-wrap">
            <input type="text" [value]="partialPickingData().formulaId" readonly />
          </div>
          <div class="input-wrap">
            <input type="text" [value]="partialPickingData().formulaDesc" readonly />
          </div>
        </div>
      </div>
      <div class="scale-switcher">
        <button
          type="button"
          class="scale-btn scale-small"
          [class.active]="selectedScaleType() === 'small'"
          (click)="onSwitchScale('small')"
          aria-label="Switch to SMALL scale">
          SMALL
        </button>
        <button
          type="button"
          class="scale-btn scale-big"
          [class.active]="selectedScaleType() === 'big'"
          (click)="onSwitchScale('big')"
          aria-label="Switch to BIG scale">
          BIG
        </button>
      </div>
    </div>

    <!-- Header Row 2: Batch No, Batches Info, Tabs -->
    <div class="header-row header-row-with-tabs">
      <div class="header-field">
        <label class="field-label">Batch No</label>
        <div class="input-wrap">
          <input type="text" formControlName="batchNo" />
          <button type="button" class="lookup-btn" (click)="onLookup('batchNo')" aria-label="Lookup batch number">üîç</button>
        </div>
      </div>
      <div class="header-field batch-field">
        <label class="field-label">Batches</label>
        <div class="meta-inline">
          <div class="input-wrap">
            <input type="text" [value]="partialPickingData().batches" readonly />
          </div>
          <label class="field-label">Production Date</label>
          <div class="input-wrap">
            <input type="text" [value]="getCurrentProductionDate()" readonly />
          </div>
        </div>
      </div>
      <div class="header-tabs">
        <div class="tab-strip">
          <button type="button" class="tab-btn active">Pending to Picked</button>
          <button type="button" class="tab-btn">Picked</button>
        </div>
      </div>
    </div>

    <!-- Main Content: Form Left, Table Right -->
    <div class="main-content">
      <div class="form-column">
        <table class="form-table">
          <tbody>
            <tr>
              <th scope="row">Item Key</th>
              <td colspan="2">
                <div class="input-wrap">
                  <input type="text" formControlName="itemKey" />
                  <button type="button" class="lookup-btn" (click)="onLookup('itemKey')" aria-label="Lookup item key">üîç</button>
                </div>
              </td>
            </tr>
            <tr>
              <th scope="row">Description</th>
              <td colspan="2">
                <div class="input-wrap">
                  <input type="text" formControlName="description" />
                </div>
              </td>
            </tr>
            <tr>
              <th scope="row">Lot No.</th>
              <td>
                <div class="input-wrap">
                  <input type="text" formControlName="lotNo" />
                  <button type="button" class="lookup-btn" (click)="onLookup('lotNo')" aria-label="Lookup lot number">üîç</button>
                </div>
              </td>
              <td class="soh-field">
                <span class="soh-text">SOH</span>
              </td>
            </tr>
            <tr>
              <th scope="row">Bin No.</th>
              <td>
                <div class="input-wrap">
                  <input type="text" formControlName="binNo" />
                  <button type="button" class="lookup-btn" (click)="onLookup('binNo')" aria-label="Lookup bin number">üîç</button>
                </div>
              </td>
              <td class="soh-display">
                <div class="soh-value-wrap">
                  <div class="soh-token">{{ binSohValue() }}</div>
                  <div class="soh-token soh-token-unit">{{ binSohUnit() }}</div>
                </div>
              </td>
            </tr>
            <tr>
              <th scope="row">Weight</th>
              <td>
                <div class="input-wrap" [class.weight-in-range]="isFormWeightInRange()" [class.weight-out-of-range]="!isFormWeightInRange() && partialPickingData().weight > 0">
                  <input type="number" formControlName="weight" inputmode="decimal" [value]="getCurrentWeightDisplay()" readonly />
                </div>
              </td>
              <td class="fetch-controls">
                <button type="button" class="fetch-btn" (click)="onFetchWeight()" [disabled]="!canFetchWeight()" [title]="canFetchWeight() ? 'Capture current weight' : 'Weight must be in tolerance range'">
                  @if (isLoading()) {
                    <span class="spinner"></span>
                    <span>Fetching</span>
                  } @else {
                    Fetch Weight
                  }
                </button>
              </td>
            </tr>
            <tr>
              <th scope="row">Weight Range</th>
              <td colspan="2">
                <div class="range-row">
                  <div class="input-wrap">
                    <input type="number" [value]="formatNumber(partialPickingData().weightRangeMin)" readonly />
                  </div>
                  <span>to</span>
                  <div class="input-wrap">
                    <input type="number" [value]="formatNumber(partialPickingData().weightRangeMax)" readonly />
                  </div>
                </div>
              </td>
            </tr>
            <tr>
              <th scope="row">Total Needed</th>
              <td colspan="2">
                <div class="input-wrap">
                  <input type="number" [value]="formatNumber(partialPickingData().totalNeeded)" readonly />
                </div>
              </td>
            </tr>
            <tr>
              <th scope="row">Remaining Qty</th>
              <td colspan="2">
                <div class="range-row">
                  <div class="input-wrap">
                    <input type="number" [value]="formatNumber(partialPickingData().remainingQty)" readonly />
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="form-actions">
          <div class="form-action-row">
            <button type="button" class="action-btn secondary" (click)="onAddLot()">Add Lot</button>
            <button type="button" class="action-btn secondary" (click)="onViewLots()">View Lots</button>
          </div>
          <div class="form-action-row form-action-row-primary">
            <button type="button" class="action-btn secondary" (click)="onPrint()">Print</button>
            <button type="button" class="action-btn" (click)="onSave()">Save</button>
          </div>
          <div class="form-action-row form-action-row-full">
            <button type="button" class="action-btn danger" (click)="onExit()">Exit</button>
          </div>
        </div>
      </div>

      <div class="table-column">
        <div class="table-panel">
          <section class="table-panel-body">
            <div class="table-scroll">
              <table class="batch-table">
                <colgroup>
                  <col />
                  <col />
                  <col />
                  <col />
                  <col />
                  <col />
                </colgroup>
                <thead>
                  <tr>
                    <th>Item</th>
                    <th>Batch No</th>
                    <th>Partial</th>
                    <th>Weighted</th>
                    <th>Balance</th>
                    <th>Allergens</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of batchTicketPartials(); track item.batchNo || i; let i = $index) {
                    <tr
                      (click)="onSelectBatchRow(i)"
                      (keydown.enter)="onSelectBatchRow(i)"
                      (keydown.space)="onSelectBatchRow(i); $event.preventDefault()"
                      [class.selected]="isBatchRowSelected(i)"
                      [attr.aria-selected]="isBatchRowSelected(i)"
                      tabindex="0"
                    >
                      <td>{{ item.item }}</td>
                      <td>{{ item.batchNo }}</td>
                      <td class="numeric">{{ formatNumber(item.partial) }}</td>
                      <td class="numeric">{{ formatNumber(item.weighted) }}</td>
                      <td class="numeric">{{ formatNumber(item.balance) }}</td>
                      <td>{{ item.allergens ?? 'None' }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </section>
        </div>
      </div>

    </div>

  </div>

  <!-- Search Modals -->
  <app-run-selection-modal
    [isOpen]="isRunModalOpen"
    [initialQuery]="''"
    [statusFilter]="''"
    (runSelected)="onRunSelected($event)"
    (modalClosed)="onRunModalClosed()">
  </app-run-selection-modal>

  <app-batch-selection-modal
    [isOpen]="isBatchModalOpen"
    [runNo]="partialPickingData().runNo"
    (batchSelected)="onBatchSelected($event)"
    (modalClosed)="onBatchModalClosed()">
  </app-batch-selection-modal>

  <app-item-selection-modal
    [isOpen]="isItemModalOpen"
    [initialQuery]="partialPickingForm.get('itemKey')?.value || ''"
    (itemSelected)="onItemSelected($event)"
    (modalClosed)="onItemModalClosed()">
  </app-item-selection-modal>

  <app-lot-selection-modal
    [isOpen]="isLotModalOpen"
    [itemKey]="modalItemKey"
    [initialQuery]="partialPickingForm.get('lotNo')?.value || ''"
    (lotSelected)="onLotSelected($event)"
    (modalClosed)="onLotModalClosed()">
  </app-lot-selection-modal>

  <app-bin-selection-modal
    [isOpen]="isBinModalOpen"
    [itemKey]="modalItemKey"
    [initialQuery]="partialPickingForm.get('binNo')?.value || ''"
    (binSelected)="onBinSelected($event)"
    (modalClosed)="onBinModalClosed()">
  </app-bin-selection-modal>

</div>
